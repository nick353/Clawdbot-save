#!/usr/bin/env python3
"""
è‡ªå‹•ãƒ¢ãƒ‡ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 
ã‚¿ã‚¹ã‚¯ã®è¤‡é›‘ã•ã«å¿œã˜ã¦Sonnet/Haikuã‚’è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
"""

import re
from typing import Tuple

class ModelRouter:
    """
    ã‚¿ã‚¹ã‚¯è¤‡é›‘åº¦ã«åŸºã¥ã„ã¦æœ€é©ãªãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ
    """
    
    # Haikuã‚’ä½¿ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆè»½é‡ã‚¿ã‚¹ã‚¯ï¼‰
    HAIKU_KEYWORDS = [
        # ç¢ºèªãƒ»æ¤œç´¢ç³»
        r'ç¢ºèª',
        r'ãƒã‚§ãƒƒã‚¯',
        r'è¦‹ã¦',
        r'è¡¨ç¤º',
        r'ãƒªã‚¹ãƒˆ',
        r'çŠ¶æ³',
        r'ã©ã†',
        r'ã‚ã‚‹\?',
        r'ãªã„\?',
        
        # ãƒ‡ãƒ¼ã‚¿å–å¾—ç³»
        r'å–å¾—',
        r'èª­[ã¿ã‚“]',
        r'é–‹[ãã„]',
        r'æ¢[ã™ã—]',
        r'æ¤œç´¢',
        
        # ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œç³»
        r'ãƒ•ã‚¡ã‚¤ãƒ«',
        r'ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª',
        r'ãƒ•ã‚©ãƒ«ãƒ€',
        r'ls',
        r'cat',
        r'grep',
        
        # å®šæœŸã‚¿ã‚¹ã‚¯
        r'ç›£è¦–',
        r'ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯',
        r'å®šæœŸ',
        
        # ç°¡å˜ãªè³ªå•
        r'ä½•[ã§ã™ã‹ãŒ]',
        r'æ•™ãˆã¦',
        r'çŸ¥ã‚ŠãŸã„',
        r'ã‚ã‹ã‚‹',
    ]
    
    # Sonnetã‚’ä½¿ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆé«˜æ€§èƒ½å¿…é ˆï¼‰
    SONNET_KEYWORDS = [
        # ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ãƒ‡ãƒãƒƒã‚°
        r'å®Ÿè£…',
        r'ä½œ[ã‚‹ã£æˆ]',
        r'ã‚³ãƒ¼ãƒ‰',
        r'ã‚¹ã‚¯ãƒªãƒ—ãƒˆ',
        r'ãƒ—ãƒ­ã‚°ãƒ©ãƒ ',
        r'ãƒ‡ãƒãƒƒã‚°',
        r'ãƒã‚°',
        r'ã‚¨ãƒ©ãƒ¼',
        r'ä¿®æ­£',
        
        # åˆ†æãƒ»è¨ˆç®—
        r'åˆ†æ',
        r'è§£æ',
        r'ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆ',
        r'è¨ˆç®—',
        r'æœ€é©åŒ–',
        
        # è¨­è¨ˆãƒ»æˆ¦ç•¥
        r'è¨­è¨ˆ',
        r'æˆ¦ç•¥',
        r'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£',
        r'æ§‹æˆ',
        r'ãƒ—ãƒ©ãƒ³',
        
        # é•·æ–‡ç”Ÿæˆ
        r'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',
        r'èª¬æ˜[ã—ã‚’]',
        r'ã¾ã¨ã‚',
        r'ãƒ¬ãƒãƒ¼ãƒˆ',
        r'æ›¸[ãã„]',
        
        # è¤‡é›‘ãªã‚¿ã‚¹ã‚¯
        r'è¤‡é›‘',
        r'é›£ã—ã„',
        r'è©³ã—ã',
        r'æ·±[ãã„]',
    ]
    
    def detect_complexity(self, message: str) -> Tuple[str, str]:
        """
        ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¤‡é›‘åº¦ã‚’åˆ¤å®šã—ã€é©åˆ‡ãªãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™
        
        Args:
            message: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            
        Returns:
            (model_name, reason)
        """
        message_lower = message.lower()
        
        # Sonnetã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆå„ªå…ˆåº¦é«˜ï¼‰
        for keyword in self.SONNET_KEYWORDS:
            if re.search(keyword, message, re.IGNORECASE):
                return "sonnet", f"è¤‡é›‘ã‚¿ã‚¹ã‚¯æ¤œå‡º: '{keyword}'"
        
        # Haikuã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        for keyword in self.HAIKU_KEYWORDS:
            if re.search(keyword, message, re.IGNORECASE):
                return "haiku", f"è»½é‡ã‚¿ã‚¹ã‚¯æ¤œå‡º: '{keyword}'"
        
        # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·ã§åˆ¤å®šï¼ˆè£œåŠ©çš„ï¼‰
        if len(message) > 500:
            return "sonnet", "é•·æ–‡ã‚¯ã‚¨ãƒªï¼ˆè©³ç´°ãªè¿”ç­”ãŒå¿…è¦ï¼‰"
        elif len(message) < 50:
            return "haiku", "çŸ­æ–‡ã‚¯ã‚¨ãƒªï¼ˆç°¡å˜ãªè¿”ç­”ã§æ¸ˆã‚€å¯èƒ½æ€§ï¼‰"
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¤‡é›‘ã•ã‚’ç·åˆåˆ¤æ–­
        # ç–‘å•ç¬¦ãŒå¤šã„ â†’ è¤‡é›‘ãªè³ªå•
        if message.count('?') > 2 or message.count('ï¼Ÿ') > 2:
            return "sonnet", "è¤‡æ•°ã®è³ªå•ï¼ˆè©³ç´°ãªè¿”ç­”ãŒå¿…è¦ï¼‰"
        
        # ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹ â†’ ã‚³ãƒ¼ãƒ‰é–¢é€£
        if '```' in message or 'python' in message_lower or 'bash' in message_lower:
            return "sonnet", "ã‚³ãƒ¼ãƒ‰é–¢é€£ã‚¿ã‚¹ã‚¯"
        
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯Haikuï¼ˆã‚³ã‚¹ãƒˆå„ªå…ˆï¼‰
        return "haiku", "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆè»½é‡ã‚¿ã‚¹ã‚¯æ¨å®šï¼‰"

# ãƒ†ã‚¹ãƒˆ
if __name__ == "__main__":
    router = ModelRouter()
    
    test_messages = [
        "ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¦‹ã›ã¦",
        "Bitgetã®ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã—ã¦",
        "ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‹ã‚‰ä¿®æ­£ã—ã¦",
        "ä»Šã®çŠ¶æ³ã‚’æ•™ãˆã¦",
        "è¤‡é›‘ãªæˆ¦ç•¥ã‚’è¨­è¨ˆã—ãŸã„",
        "ç¢ºèªã—ã¦ãã ã•ã„",
        "è©³ã—ãåˆ†æã—ã¦",
    ]
    
    print("ğŸ¥ è‡ªå‹•ãƒ¢ãƒ‡ãƒ«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ã‚¹ãƒˆ\n")
    
    for msg in test_messages:
        model, reason = router.detect_complexity(msg)
        print(f"ğŸ“ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {msg}")
        print(f"ğŸ¤– é¸æŠãƒ¢ãƒ‡ãƒ«: {model}")
        print(f"ğŸ’¡ ç†ç”±: {reason}\n")
