# Bitget自動トレーダー 再起動対応ポリシー

**作成日:** 2026-02-14
**対応者:** リッキー 🐥

---

## 🎯 基本方針

**再起動が1回でも検出されたら、必ず根本原因を調査して修正する**

---

## 🔍 監視体制

### 1. 自動診断（1時間ごと）
- cronで毎時0分に実行
- ログから再起動を検出
- 1回でも検出したら即座に詳細調査を起動

### 2. 詳細調査（再起動検出時）
- 再起動前後のログを分析
- 原因パターンマッチング:
  - OOM (Out of Memory)
  - 未処理の例外
  - APIタイムアウト
  - systemd強制終了
  - その他のクラッシュ

### 3. 自動修正
- 原因に応じた修正を自動適用
- Discord報告（必須）

---

## 🛠️ 原因別の対応

### 1. OOM (メモリ不足)
**症状:**
- `MemoryError` または `out of memory`
- systemdが `SIGKILL` を送信

**修正:**
- ガベージコレクションを強化
- メモリ使用量を削減
- systemdの `MemoryMax` を緩和

### 2. 未処理の例外
**症状:**
- `Traceback` がログに出力
- 例外が `except` でキャッチされていない

**修正:**
- メインループに `try-except` 追加
- エラーハンドリングを強化
- トレースバックを詳細にログ

### 3. APIタイムアウト
**症状:**
- `timeout` または `timed out`
- Bitget APIが応答しない

**修正:**
- タイムアウト値を延長（10秒 → 30秒）
- リトライロジックを追加
- API呼び出しにフォールバック

### 4. systemd強制終了
**症状:**
- `SIGKILL` または `killed`
- リソース制限超過

**修正:**
- `TimeoutStopSec` を延長
- リソース制限を調整
- グレースフルシャットダウンを改善

### 5. チェック#30クラッシュ（過去の問題）
**症状:**
- チェック#30付近で再起動
- 原因不明のクラッシュ

**修正:**
- `robust_sleep()` の強化
- シグナルハンドリングの改善
- KVM環境対応

---

## 📋 実行スクリプト

### 自動診断
```bash
/root/clawd/scripts/bitget-self-diagnosis.py
```
- 1時間ごとにcronで実行
- 再起動を検出したら詳細調査を起動

### 詳細調査
```bash
/root/clawd/scripts/bitget-restart-investigator.py
```
- 再起動の根本原因を調査
- 原因別の修正案を生成
- Discord報告

### 手動調査
```bash
# 最新の再起動を調査
python3 /root/clawd/scripts/bitget-restart-investigator.py

# systemdログを確認
journalctl -u bitget-trader.service -n 100

# トレーダーログを確認
tail -100 /root/clawd/data/trader-v2.log
```

---

## 📊 監視ポイント

### 日次チェック
- [ ] 過去24時間の再起動回数: `0回` が目標
- [ ] メモリ使用率: `80%以下` を維持
- [ ] トレード成功率: `50%以上` を維持

### 週次レビュー
- [ ] 再起動の傾向分析
- [ ] 修正の効果確認
- [ ] システム安定性評価

---

## 🚨 エスカレーション

### 即座にandoさんに報告する条件
1. **1時間以内に3回以上の再起動**
2. **同じ原因で3回以上の再起動**
3. **自動修正が失敗**
4. **データ損失のリスク**

### 報告フォーマット
```
🚨 **緊急: Bitget自動トレーダー異常**

**状況:** [簡潔に説明]
**再起動回数:** N回
**原因:** [判明している原因]
**実施した対応:** [修正内容]
**現在の状態:** [実行中/停止中]

**詳細レポート:**
[ファイルパス]
```

---

## 📝 修正履歴

### 2026-02-14 14:00
- **問題:** 診断レポートで「4回の再起動」を検出
- **原因:** 診断スクリプトの誤検出 + 修正前のログが含まれていた
- **対応:**
  1. 診断スクリプトの検出ロジック修正
  2. 詳細調査スクリプトを作成
  3. 1回の再起動でも即座に調査するように変更
- **結果:** 11:03以降は再起動なし（3時間稼働中）

### 2026-02-14 11:03
- **問題:** 予期しない再起動（10回/1000行）
- **原因:** systemd設定の不備 + 二重管理の競合
- **対応:**
  1. systemdサービスファイル最適化
  2. watchdogスクリプト調整
- **結果:** 再起動ゼロ化に成功

---

## 🎯 目標

**短期目標（1週間）:**
- 再起動回数: 0回/週
- 連続稼働時間: 7日間

**長期目標（1ヶ月）:**
- 再起動回数: 0回/月
- システム安定性: 99.9%

---

**最終更新:** 2026-02-14 14:00 UTC
**次回レビュー:** 2026-02-21 14:00 UTC（1週間後）
